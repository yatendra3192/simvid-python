<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Aiezzy Video</title>
    <link rel="icon" type="image/png" href="https://aiezzy.com/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; box-shadow: 0 10px 40px var(--shadow); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--accent); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--gradient); }
        .login-card { background: var(--bg-secondary); padding: 48px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5); }
        .login-card h1 { text-align: center; margin-bottom: 8px; font-size: 28px; }
        .login-card p { text-align: center; color: var(--text-secondary); margin-bottom: 32px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .input-group input { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px; transition: all 0.3s; }
        .input-group input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }

        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gradient); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 16px; font-size: 12px; }

        /* Dashboard Layout */
        .dashboard { display: none; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; }
        .sidebar-logo img { width: 36px; height: 36px; border-radius: 8px; }
        .sidebar-logo span { font-size: 18px; font-weight: 700; }
        .nav-menu { flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-size: 14px; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-item svg { width: 18px; height: 18px; }

        .main-content { margin-left: 260px; padding: 24px; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header h1 { font-size: 24px; font-weight: 700; }
        .header-actions { display: flex; gap: 12px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-secondary); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 20px; }
        .stat-card .icon.blue { background: rgba(59, 130, 246, 0.2); }
        .stat-card .icon.green { background: rgba(34, 197, 94, 0.2); }
        .stat-card .icon.purple { background: rgba(139, 92, 246, 0.2); }
        .stat-card .icon.orange { background: rgba(245, 158, 11, 0.2); }
        .stat-card .value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-card .label { color: var(--text-secondary); font-size: 13px; }

        /* Content Sections */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Project Cards - Main View */
        .projects-grid { display: flex; flex-direction: column; gap: 20px; }

        .project-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }
        .project-card:hover { border-color: var(--accent); box-shadow: 0 10px 40px var(--shadow); }

        .project-header {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        /* Video Preview */
        .project-video {
            width: 320px;
            min-width: 320px;
            height: 220px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .project-video video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        /* Project Info */
        .project-info { flex: 1; display: flex; flex-direction: column; }
        .project-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .project-meta { display: flex; flex-wrap: wrap; gap: 12px; color: var(--text-secondary); font-size: 13px; margin-bottom: 12px; }
        .project-meta span { display: flex; align-items: center; gap: 4px; }
        .project-actions { display: flex; gap: 8px; margin-top: auto; }

        /* Image Carousel */
        .project-images-carousel {
            position: relative;
            padding: 0 20px 20px;
        }
        .carousel-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .carousel-nav {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .carousel-nav:hover { background: var(--accent); border-color: var(--accent); }
        .carousel-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .carousel-track {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            flex: 1;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .carousel-track::-webkit-scrollbar { display: none; }
        .image-thumb {
            width: 70px;
            height: 70px;
            min-width: 70px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
        }
        .image-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
        .image-thumb.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .image-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .image-thumb.more {
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }
        .image-thumb.more:hover { background: var(--accent-hover); transform: scale(1.05); }

        /* All Images Modal */
        .all-images-modal {
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .all-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .all-images-grid .thumb {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }
        .all-images-grid .thumb:hover { border-color: var(--accent); transform: scale(1.02); }
        .all-images-grid .thumb img { width: 100%; height: 100%; object-fit: cover; }

        /* Audio Info in Project */
        .project-audio {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .project-audio img {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }
        .project-audio .audio-info { flex: 1; }
        .project-audio .audio-title { font-size: 13px; font-weight: 500; }
        .project-audio .audio-source { font-size: 11px; color: var(--text-secondary); }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge.blue { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .badge.green { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .badge.purple { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }

        /* File Cards for Legacy Views */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .file-card { background: var(--bg-secondary); border-radius: 14px; border: 1px solid var(--border); overflow: hidden; transition: all 0.2s; }
        .file-card:hover { border-color: var(--accent); }
        .file-card .preview { height: 160px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .file-card .preview img, .file-card .preview video { width: 100%; height: 100%; object-fit: cover; }
        .file-card .info { padding: 14px; }
        .file-card .name { font-weight: 600; margin-bottom: 6px; word-break: break-all; font-size: 13px; }
        .file-card .meta { display: flex; flex-wrap: wrap; gap: 10px; color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; }
        .file-card .actions { display: flex; gap: 8px; }

        /* Image grid in file card */
        .image-grid-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 100%;
            height: 100%;
        }
        .image-grid-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-grid-preview .more-overlay {
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* Audio waveform animation */
        .audio-waveform { display: flex; align-items: center; justify-content: center; gap: 3px; height: 50px; }
        .audio-waveform span { width: 4px; background: var(--accent); border-radius: 2px; animation: wave 1s ease-in-out infinite; }
        .audio-waveform span:nth-child(1) { height: 18px; animation-delay: 0s; }
        .audio-waveform span:nth-child(2) { height: 30px; animation-delay: 0.1s; }
        .audio-waveform span:nth-child(3) { height: 45px; animation-delay: 0.2s; }
        .audio-waveform span:nth-child(4) { height: 35px; animation-delay: 0.3s; }
        .audio-waveform span:nth-child(5) { height: 22px; animation-delay: 0.4s; }
        .audio-waveform span:nth-child(6) { height: 40px; animation-delay: 0.5s; }
        .audio-waveform span:nth-child(7) { height: 28px; animation-delay: 0.6s; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }

        /* Settings Section */
        .settings-card { background: var(--bg-secondary); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 16px; }
        .settings-card h3 { margin-bottom: 12px; font-size: 16px; }
        .settings-card p { color: var(--text-secondary); margin-bottom: 16px; font-size: 14px; }
        .settings-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .select-box { padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        /* Loading */
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg-secondary); border-radius: 16px; padding: 28px; width: 100%; max-width: 500px; }
        .modal h2 { margin-bottom: 8px; }
        .modal p { color: var(--text-secondary); margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }

        /* Image Preview Modal */
        .image-modal { max-width: 90vw; max-height: 90vh; padding: 0; background: transparent; }
        .image-modal img { max-width: 100%; max-height: 90vh; border-radius: 12px; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 220px; }
            .main-content { margin-left: 220px; }
            .project-header { flex-direction: column; }
            .project-video { width: 100%; height: 200px; }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>

    <!-- Login -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1>Admin Dashboard</h1>
            <p>Sign in to manage Aiezzy Video</p>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="passwordInput" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn btn-primary" onclick="login()">Sign In</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="https://aiezzy.com/logo.png" alt="Aiezzy">
                <span>Admin</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="showSection('projects')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Projects
                </div>
                <div class="nav-item" onclick="showSection('images')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Images
                </div>
                <div class="nav-item" onclick="showSection('audio')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                    Audio
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </div>
            </nav>
            <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">Logout</button>
        </aside>

        <main class="main-content">
            <!-- Projects Section -->
            <section id="sectionProjects" class="content-section active">
                <div class="header">
                    <h1>Projects</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadData()">Refresh</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon green">&#127909;</div>
                        <div class="value" id="statProjects">0</div>
                        <div class="label">Total Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue">&#128247;</div>
                        <div class="value" id="statImages">0</div>
                        <div class="label">Images Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple">&#127925;</div>
                        <div class="value" id="statAudioUsed">0</div>
                        <div class="label">Audio Tracks</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon orange">&#128190;</div>
                        <div class="value" id="statStorage">0 MB</div>
                        <div class="label">Storage Used</div>
                    </div>
                </div>

                <div id="projectsList" class="projects-grid">
                    <div class="loading"><div class="spinner"></div><p>Loading projects...</p></div>
                </div>
            </section>

            <!-- Images Section -->
            <section id="sectionImages" class="content-section">
                <div class="header">
                    <h1>Image Sessions</h1>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Uploaded image sessions that haven't been used in a project yet, or are orphaned.</p>
                <div id="imagesList" class="file-grid">
                    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
                </div>
            </section>

            <!-- Audio Section -->
            <section id="sectionAudio" class="content-section">
                <div class="header">
                    <h1>Audio Files</h1>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Downloaded audio files available for video projects.</p>
                <div id="audioList" class="file-grid">
                    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="sectionSettings" class="content-section">
                <div class="header">
                    <h1>Settings</h1>
                </div>

                <div class="settings-card">
                    <h3>Cleanup Files</h3>
                    <p>Delete files older than the specified time. This cannot be undone.</p>
                    <div class="settings-row">
                        <span>Delete files older than:</span>
                        <select class="select-box" id="cleanupHours">
                            <option value="1">1 hour</option>
                            <option value="6">6 hours</option>
                            <option value="24">24 hours</option>
                            <option value="72">3 days</option>
                            <option value="168">7 days</option>
                        </select>
                        <button class="btn btn-danger" onclick="cleanupFiles()">Run Cleanup</button>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Export Data</h3>
                    <p>Download a JSON export of all sessions and files.</p>
                    <button class="btn btn-secondary" onclick="exportData()">Download Export</button>
                </div>

                <div class="settings-card">
                    <h3>About</h3>
                    <p>Aiezzy Video - Slideshow Video Generator<br>Admin Panel v3.0 - Project View</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Cleanup Modal -->
    <div id="cleanupModal" class="modal-overlay">
        <div class="modal">
            <h2>Cleanup Complete</h2>
            <p id="cleanupResult">Deleted 0 files.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('cleanupModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="modal-overlay" onclick="closeModal('imagePreviewModal')">
        <div class="modal image-modal">
            <img id="previewImage" src="" alt="Preview">
        </div>
    </div>

    <!-- All Images Modal -->
    <div id="allImagesModal" class="modal-overlay" onclick="if(event.target === this) closeModal('allImagesModal')">
        <div class="modal all-images-modal">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h2 id="allImagesCount">Images</h2>
                <button class="btn btn-secondary btn-sm" onclick="closeModal('allImagesModal')">Close</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">Click any image to view full size</p>
            <div id="allImagesGrid" class="all-images-grid"></div>
        </div>
    </div>

    <script>
        let data = { images: [], audio: [], videos: [], stats: {} };
        let projects = [];
        const token = () => localStorage.getItem('adminToken');

        checkAuth();

        function checkAuth() {
            const t = token();
            if (t) {
                fetch('/admin/verify', { headers: { 'Authorization': t } })
                    .then(r => r.json())
                    .then(d => d.valid ? showDashboard() : showLogin())
                    .catch(() => showLogin());
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        }

        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) return toast('Please enter password', 'error');
            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const d = await res.json();
                if (d.success) {
                    localStorage.setItem('adminToken', d.token);
                    showDashboard();
                    toast('Welcome back!', 'success');
                } else {
                    toast(d.error || 'Invalid password', 'error');
                }
            } catch (e) {
                toast('Login failed', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            showLogin();
        }

        async function loadData() {
            try {
                // Load projects
                const projectsRes = await fetch('/admin/projects', { headers: { 'Authorization': token() } });
                const projectsData = await projectsRes.json();
                projects = projectsData.projects || [];

                // Load other data for legacy views
                const dataRes = await fetch('/admin/data', { headers: { 'Authorization': token() } });
                data = await dataRes.json();

                updateStats();
                renderProjects();
                renderImages();
                renderAudio();
            } catch (e) {
                toast('Failed to load data', 'error');
            }
        }

        function updateStats() {
            document.getElementById('statProjects').textContent = projects.length;

            let totalImages = 0;
            let audioCount = 0;
            projects.forEach(p => {
                totalImages += p.images?.length || 0;
                if (p.audio) audioCount++;
            });

            document.getElementById('statImages').textContent = totalImages;
            document.getElementById('statAudioUsed').textContent = audioCount;
            document.getElementById('statStorage').textContent = formatSize(data.stats?.total_size || 0);
        }

        function renderProjects() {
            const list = document.getElementById('projectsList');

            if (projects.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    <div class="icon">&#127909;</div>
                    <p>No projects yet. Generate a video to see it here.</p>
                </div>`;
                return;
            }

            list.innerHTML = projects.map((p, projectIndex) => {
                const video = p.video || {};
                const images = p.images || [];
                const audio = p.audio;
                const settings = p.settings || {};

                // Video preview URL
                const videoUrl = `/admin/preview/video/${video.id}?token=${token()}`;

                // Image carousel - show 6 visible at a time
                const visibleCount = 6;
                const showNav = images.length > visibleCount;
                const moreCount = images.length - visibleCount;

                let carouselHtml = '';
                if (images.length > 0) {
                    const displayImages = images.slice(0, visibleCount);
                    const thumbsHtml = displayImages.map((img, i) => `
                        <div class="image-thumb" onclick="previewImage('${p.session_id}', '${img.name}')">
                            <img src="/admin/preview/image/${img.session_id}/${img.name}?token=${token()}" alt="" loading="lazy">
                        </div>
                    `).join('');

                    const moreBtn = moreCount > 0 ? `
                        <div class="image-thumb more" onclick="showAllImages('${p.id}', ${projectIndex})">
                            +${moreCount}
                        </div>
                    ` : '';

                    carouselHtml = `
                        <div class="project-images-carousel">
                            <div class="carousel-container">
                                ${showNav ? `<button class="carousel-nav" onclick="scrollCarousel('${p.id}', -1)">&#10094;</button>` : ''}
                                <div class="carousel-track" id="carousel-${p.id}">
                                    ${thumbsHtml}
                                    ${moreBtn}
                                </div>
                                ${showNav ? `<button class="carousel-nav" onclick="scrollCarousel('${p.id}', 1)">&#10095;</button>` : ''}
                            </div>
                        </div>
                    `;
                }

                // Audio section
                let audioHtml = '';
                if (audio) {
                    const thumbUrl = audio.video_id
                        ? `https://img.youtube.com/vi/${audio.video_id}/mqdefault.jpg`
                        : '';
                    audioHtml = `
                        <div class="project-audio">
                            ${thumbUrl
                                ? `<img src="${thumbUrl}" alt="YouTube">`
                                : `<div style="width:40px;height:40px;background:var(--bg-primary);border-radius:6px;display:flex;align-items:center;justify-content:center;">&#127925;</div>`
                            }
                            <div class="audio-info">
                                <div class="audio-title">${audio.title || audio.name || 'Audio Track'}</div>
                                <div class="audio-source">${audio.video_id ? 'YouTube' : 'Uploaded'} â€¢ ${formatSize(audio.size || 0)}</div>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="project-card" data-id="${p.id}" data-images='${JSON.stringify(images)}' data-session="${p.session_id || ''}">
                        <div class="project-header">
                            <div class="project-video">
                                <video controls preload="metadata" playsinline>
                                    <source src="${videoUrl}" type="video/mp4">
                                </video>
                            </div>
                            <div class="project-info">
                                <div class="project-title">
                                    <span class="badge green">Video</span>
                                    Project ${p.id.substring(0, 8)}
                                </div>
                                <div class="project-meta">
                                    <span>&#128247; ${images.length} images</span>
                                    <span>&#128337; ${settings.duration || 2}s per slide</span>
                                    <span>&#128250; ${settings.resolution || 'Unknown'}</span>
                                    <span>&#128190; ${formatSize(video.size || 0)}</span>
                                </div>
                                ${audioHtml}
                                <div class="project-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="window.open('/download/${video.id}')">Download Video</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}')">Delete Project</button>
                                </div>
                            </div>
                        </div>
                        ${carouselHtml}
                    </div>
                `;
            }).join('');
        }

        function scrollCarousel(projectId, direction) {
            const track = document.getElementById(`carousel-${projectId}`);
            if (track) {
                const scrollAmount = 160; // ~2 thumbnails
                track.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        }

        function showAllImages(projectId, projectIndex) {
            const card = document.querySelector(`.project-card[data-id="${projectId}"]`);
            if (!card) return;

            const images = JSON.parse(card.dataset.images || '[]');
            const sessionId = card.dataset.session;

            if (images.length === 0) return;

            const grid = document.getElementById('allImagesGrid');
            grid.innerHTML = images.map(img => `
                <div class="thumb" onclick="previewImage('${sessionId}', '${img.name}')">
                    <img src="/admin/preview/image/${img.session_id}/${img.name}?token=${token()}" alt="" loading="lazy">
                </div>
            `).join('');

            document.getElementById('allImagesCount').textContent = `${images.length} Images`;
            document.getElementById('allImagesModal').classList.add('show');
        }

        function renderImages() {
            const list = document.getElementById('imagesList');
            const sessions = data.images || [];

            if (sessions.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">&#128247;</div><p>No image sessions</p></div>';
                return;
            }

            list.innerHTML = sessions.map(s => {
                const images = s.images || [];
                const displayImages = images.slice(0, 6);

                let previewHtml = '';
                if (displayImages.length > 0) {
                    previewHtml = `<div class="image-grid-preview">`;
                    displayImages.forEach((img, i) => {
                        if (i < 5) {
                            previewHtml += `<img src="/admin/preview/image/${s.session_id}/${img.name}?token=${token()}" alt="" loading="lazy">`;
                        } else if (i === 5 && images.length > 6) {
                            previewHtml += `<div class="more-overlay">+${images.length - 5}</div>`;
                        } else {
                            previewHtml += `<img src="/admin/preview/image/${s.session_id}/${img.name}?token=${token()}" alt="" loading="lazy">`;
                        }
                    });
                    previewHtml += `</div>`;
                } else {
                    previewHtml = `<span style="font-size:40px;">&#128247;</span>`;
                }

                return `
                    <div class="file-card" data-id="${s.session_id}">
                        <div class="preview">${previewHtml}</div>
                        <div class="info">
                            <div class="name">Session ${s.session_id.substring(0, 8)}...</div>
                            <div class="meta">
                                <span class="badge blue">${s.image_count} images</span>
                                <span>${formatSize(s.total_size)}</span>
                            </div>
                            <div class="actions">
                                <button class="btn btn-danger btn-sm" onclick="deleteSession('${s.session_id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAudio() {
            const list = document.getElementById('audioList');
            const audioFiles = data.audio || [];

            if (audioFiles.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">&#127925;</div><p>No audio files</p></div>';
                return;
            }

            list.innerHTML = audioFiles.map(a => {
                const isYouTube = a.video_id;
                let previewHtml = '';

                if (isYouTube) {
                    previewHtml = `<img src="https://img.youtube.com/vi/${a.video_id}/mqdefault.jpg" alt="YouTube" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    previewHtml = `<div class="audio-waveform"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>`;
                }

                return `
                    <div class="file-card" data-id="${a.id}">
                        <div class="preview">${previewHtml}</div>
                        <div class="info">
                            <div class="name">${a.title || a.name}</div>
                            <div class="meta">
                                <span class="badge purple">${isYouTube ? 'YouTube' : 'Upload'}</span>
                                <span>${formatSize(a.size)}</span>
                            </div>
                            <div class="actions">
                                <button class="btn btn-secondary btn-sm" onclick="window.open('/admin/download/audio/${a.id}')">Download</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAudio('${a.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
        }

        function previewImage(sessionId, filename) {
            const img = document.getElementById('previewImage');
            img.src = `/admin/preview/image/${sessionId}/${filename}?token=${token()}`;
            document.getElementById('imagePreviewModal').classList.add('show');
        }

        function toggleVideo(container) {
            const video = container.querySelector('video');
            if (video.paused) {
                // Pause all other videos first
                document.querySelectorAll('.project-video video').forEach(v => {
                    if (v !== video) {
                        v.pause();
                        v.currentTime = 0;
                        v.closest('.project-video').classList.remove('playing');
                    }
                });
                video.play();
                container.classList.add('playing');
            } else {
                video.pause();
                container.classList.remove('playing');
            }
        }

        async function deleteProject(id) {
            if (!confirm('Delete this project? This will delete the video file.')) return;
            await fetch(`/admin/delete/video/${id}`, { method: 'DELETE', headers: { 'Authorization': token() } });
            toast('Project deleted', 'success');
            loadData();
        }

        async function deleteSession(id) {
            if (!confirm('Delete this image session?')) return;
            await fetch(`/admin/delete/session/${id}`, { method: 'DELETE', headers: { 'Authorization': token() } });
            toast('Session deleted', 'success');
            loadData();
        }

        async function deleteAudio(id) {
            if (!confirm('Delete this audio file?')) return;
            await fetch(`/admin/delete/audio/${id}`, { method: 'DELETE', headers: { 'Authorization': token() } });
            toast('Audio deleted', 'success');
            loadData();
        }

        async function cleanupFiles() {
            const hours = parseInt(document.getElementById('cleanupHours').value);
            if (!confirm(`Delete all files older than ${hours} hour(s)?`)) return;

            try {
                const res = await fetch('/admin/cleanup', {
                    method: 'POST',
                    headers: { 'Authorization': token(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours })
                });
                const d = await res.json();
                document.getElementById('cleanupResult').textContent = `Deleted ${d.deleted_count} files.`;
                document.getElementById('cleanupModal').classList.add('show');
                loadData();
            } catch (e) {
                toast('Cleanup failed', 'error');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        async function exportData() {
            window.open(`/admin/export?token=${token()}`, '_blank');
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }

        function toast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = message;
            container.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }
    </script>
</body>
</html>
